<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 25404</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25402.html">25402</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25404">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25480.html">25480</a></span></td>
</tr>
</table>
<div class="description">25404: Guide a character to an intermediate destination</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this interruptible subcommand routine is placed into bytes 105 and 106 of the character's buffer by the routines at <a class="link" href="25303.html">25303</a>, <a class="link" href="25534.html">25534</a>, <a class="link" href="31854.html">31854</a> and <a class="link" href="32048.html">32048</a>. It is used to make a character go straight to a destination (or intermediate destination) that is reachable without negotiating any staircases.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (152-169)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25404"></a>25404</td>
<td class="instruction">LD L,108</td>
<td class="comment-11" rowspan="3">The counter at byte 108 of the character's buffer is initialised by the calling routine to limit the amount of time that this routine has control; terminate this interruptible subcommand if the counter is now zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25406"></a>25406</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25407"></a>25407</td>
<td class="instruction">JP Z,<a class="link" href="25248.html#25252">25252</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25410"></a>25410</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">Collect the x-coordinate of the intermediate destination from byte 107 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25411"></a>25411</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25412"></a>25412</td>
<td class="instruction">LD L,98</td>
<td class="comment-11" rowspan="1">Byte 98 of the character's buffer holds his x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25414"></a>25414</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="1">Has the character reached the intermediate destination?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25415"></a>25415</td>
<td class="instruction">JR NZ,25423</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25417"></a>25417</td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="1">Byte 96 of the character's buffer holds his animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25419"></a>25419</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the character midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25421"></a>25421</td>
<td class="instruction">JR Z,25407</td>
<td class="comment-11" rowspan="1">Jump if not (nothing left to do)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25423"></a>25423</td>
<td class="instruction">CALL <a class="link" href="25108.html">25108</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the character's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25426"></a>25426</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Store the character's animatory state in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25427"></a>25427</td>
<td class="instruction">LD L,107</td>
<td class="comment-11" rowspan="2">Collect the x-coordinate of the intermediate destination from byte 107 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25429"></a>25429</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25430"></a>25430</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span> holds the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25431"></a>25431</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25432"></a>25432</td>
<td class="instruction">JR NZ,25440</td>
<td class="comment-11" rowspan="1">Jump unless the character has reached the destination</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25434"></a>
<div class="comments">
<div class="paragraph">
The character has reached the destination, but he is midstride. To complete the journey, he must finish his stride. This entry point is also used by the routine at <a class="link" href="27772.html">27772</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25434"></a>25434</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25436"></a>25436</td>
<td class="instruction">JR Z,25449</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25438"></a>25438</td>
<td class="instruction">JR 25471</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25440"></a>
<div class="comments">
<div class="paragraph">
The character has not yet reached the destination. Figure out his next move.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25440"></a>25440</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Now the zero flag indicates which way the character is facing: set=left, reset=right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25442"></a>25442</td>
<td class="instruction">JR NC,25466</td>
<td class="comment-11" rowspan="1">Jump if the character is to the left of his destination</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25444"></a>
<div class="comments">
<div class="paragraph">
The character is to the right of his destination, and so must proceed leftwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25444"></a>25444</td>
<td class="instruction">RES 7,A</td>
<td class="comment-11" rowspan="1">Make sure the character is facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25446"></a>25446</td>
<td class="instruction">JP NZ,<a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and update the SRB if he was facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25449"></a>25449</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25450"></a>25450</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Will the character be midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25452"></a>25452</td>
<td class="instruction">JP NZ,<a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and update the SRB if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25455"></a>25455</td>
<td class="instruction">DEC E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=character's next x-coordinate (one to the left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25456"></a>25456</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="5">Calculate the character's next animatory state in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25458"></a>25458</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25459"></a>25459</td>
<td class="instruction">LD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25460"></a>25460</td>
<td class="instruction">AND 252</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25462"></a>25462</td>
<td class="instruction">ADD A,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25463"></a>25463</td>
<td class="instruction">JP <a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25466"></a>
<div class="comments">
<div class="paragraph">
The character is to the left of his destination, and so must proceed rightwards.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25466"></a>25466</td>
<td class="instruction">SET 7,A</td>
<td class="comment-11" rowspan="1">Make sure the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25468"></a>25468</td>
<td class="instruction">JP Z,<a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and update the SRB if the character was facing left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25471"></a>25471</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's next animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25472"></a>25472</td>
<td class="instruction">BIT 0,A</td>
<td class="comment-11" rowspan="1">Will the character be midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25474"></a>25474</td>
<td class="instruction">JP NZ,<a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the character's animatory state and update the SRB if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25477"></a>25477</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=character's next x-coordinate (one to the right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25478"></a>25478</td>
<td class="instruction">JR 25456</td>
<td class="comment-11" rowspan="1">Jump back to update the character's animatory state and location and update the SRB</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25402.html">25402</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25404">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25480.html">25480</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>