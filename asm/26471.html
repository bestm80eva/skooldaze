<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 26471</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="26450.html">26450</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26471">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="26572.html">26572</a></span></td>
</tr>
</table>
<div class="description">26471: Main loop</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Entered from the routine at <a class="link" href="63768.html">63768</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26471"></a>26471</td>
<td class="instruction">LD HL,(32759)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32759.html">32759</a> holds the lesson clock</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26474"></a>26474</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="4">Decrease it by 1 and set the zero flag if it's time to ring the bell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26475"></a>26475</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26476"></a>26476</td>
<td class="instruction">OR L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26477"></a>26477</td>
<td class="instruction">LD (32759),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26480"></a>26480</td>
<td class="instruction">CALL Z,<a class="link" href="26342.html">26342</a></td>
<td class="comment-11" rowspan="1">Change the lesson if the lesson clock reached zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26483"></a>26483</td>
<td class="instruction">CALL <a class="link" href="25126.html">25126</a></td>
<td class="comment-11" rowspan="1">Move the characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26486"></a>26486</td>
<td class="instruction">CALL <a class="link" href="27353.html">27353</a></td>
<td class="comment-11" rowspan="1">Move ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26489"></a>26489</td>
<td class="instruction">JR C,26556</td>
<td class="comment-11" rowspan="1">Jump if ERIC has already been dealt with</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26491"></a>26491</td>
<td class="instruction">LD HL,32744</td>
<td class="comment-11" rowspan="2">Decrement ERIC's main action timer at <a class="link" href="32744.html">32744</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26494"></a>26494</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26495"></a>26495</td>
<td class="instruction">JR NZ,26556</td>
<td class="comment-11" rowspan="1">Jump unless it's time to deal with ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26497"></a>26497</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Pick up the midstride indicator at <a class="link" href="32745.html">32745</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26498"></a>26498</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26499"></a>26499</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is ERIC midstride?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26500"></a>26500</td>
<td class="instruction">JR Z,26507</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26502"></a>26502</td>
<td class="instruction">CALL <a class="link" href="25856.html">25856</a></td>
<td class="comment-11" rowspan="1">Move ERIC from the midstride position, then scroll the screen left or right if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26505"></a>26505</td>
<td class="instruction">JR 26559</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26507"></a>
<div class="comments">
<div class="paragraph">
Time to check the keyboard (or simulate a keypress in demo mode) to see how ERIC should move next.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26507"></a>26507</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">Reset ERIC's main action timer at <a class="link" href="32744.html">32744</a> to 9</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26508"></a>26508</td>
<td class="instruction">LD (HL),9</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26510"></a>26510</td>
<td class="instruction">CALL <a class="link" href="62938.html">62938</a></td>
<td class="comment-11" rowspan="1">Collect or simulate a keypress</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26513"></a>26513</td>
<td class="instruction">JR Z,26556</td>
<td class="comment-11" rowspan="1">Jump if no relevant keypress was collected or simulated</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26515"></a>26515</td>
<td class="instruction">LD HL,32763</td>
<td class="comment-11" rowspan="1"><a class="link" href="32763.html">32763</a> holds ERIC's status flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26518"></a>26518</td>
<td class="instruction">BIT 5,(HL)</td>
<td class="comment-11" rowspan="1">Is ERIC writing on a blackboard?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26520"></a>26520</td>
<td class="instruction">JR Z,26527</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26522"></a>26522</td>
<td class="instruction">CALL <a class="link" href="63146.html">63146</a></td>
<td class="comment-11" rowspan="1">Deal with keypresses while ERIC is writing on the board</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26525"></a>26525</td>
<td class="instruction">JR 26556</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26527"></a>26527</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2"><span class="register">DE</span>=<a class="link" href="32764.html">32764</a> (which holds the ASCII code of the last keypress)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26528"></a>26528</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26529"></a>26529</td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">Was the keypress ASCII code &gt;= 32?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26531"></a>26531</td>
<td class="instruction">JR C,26556</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26533"></a>26533</td>
<td class="instruction">LD HL,26556</td>
<td class="comment-11" rowspan="2">Push the address of the entry point at <a class="link" href="26471.html#26556">26556</a> (see below) onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26536"></a>26536</td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26537"></a>26537</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="3">Point <span class="register">HL</span> at the appropriate entry in the <a class="link" href="26656.html">keypress offset table</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26538"></a>26538</td>
<td class="instruction">LD H,104</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26540"></a>26540</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26541"></a>26541</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">Copy the ASCII code of the keypress into <a class="link" href="32764.html">32764</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26543"></a>26543</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="3">Pick up in <span class="register">DE</span> the address of the appropriate routine for dealing with the keypress</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26544"></a>26544</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26545"></a>26545</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26546"></a>26546</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Push this address onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26547"></a>26547</td>
<td class="instruction">LD HL,44128</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 96 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26550"></a>26550</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="5">Pick up ERIC's animatory state in <span class="register">B</span> and his coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26551"></a>26551</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26552"></a>26552</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26553"></a>26553</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26554"></a>26554</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26555"></a>26555</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Make an indirect jump to the appropriate routine for dealing with ERIC, then return to <a class="link" href="26471.html#26556">26556</a> below</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26556"></a>
<div class="comments">
<div class="paragraph">
Now that ERIC has been moved or otherwise dealt with, update the display.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26556"></a>26556</td>
<td class="instruction">CALL <a class="link" href="27026.html">27026</a></td>
<td class="comment-11" rowspan="1">Update the display</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26559"></a>
<div class="comments">
<div class="paragraph">
The next section of code ensures that we don't pass through the main loop more than once every 20 milliseconds.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26559"></a>26559</td>
<td class="instruction">LD HL,32762</td>
<td class="comment-11" rowspan="5">Wait until the system variable FRAMES at 23672 has been incremented since the last time it was checked (FRAMES is incremented every 20ms)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26562"></a>26562</td>
<td class="instruction">LD A,(23672)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26565"></a>26565</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26566"></a>26566</td>
<td class="instruction">JR Z,26562</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26568"></a>26568</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26569"></a>26569</td>
<td class="instruction">JP 26471</td>
<td class="comment-11" rowspan="1">Jump back to the beginning of the main loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="26450.html">26450</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26471">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="26572.html">26572</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20150413</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>