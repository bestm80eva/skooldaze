<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 31648</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31638.html">31638</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31648">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31739.html">31739</a></span></td>
</tr>
</table>
<div class="description">31648: Make a teacher find the truant ERIC</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="31854.html">31854</a>, which also places the address of this interruptible subcommand routine into bytes 105 and 106 of the teacher's buffer when ERIC is absent during dinner or class. It makes the teacher run after and stalk ERIC until he goes to wherever he should be (the dinner hall or the classroom).
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Teacher's character number (163-166)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31648"></a>31648</td>
<td class="instruction">CALL <a class="link" href="31229.html">31229</a></td>
<td class="comment-11" rowspan="1">Get ERIC's coordinates in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31651"></a>31651</td>
<td class="instruction">CALL <a class="link" href="32234.html">32234</a></td>
<td class="comment-11" rowspan="1">Make this teacher walk fast</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31654"></a>31654</td>
<td class="instruction">CALL <a class="link" href="31452.html">31452</a></td>
<td class="comment-11" rowspan="1">Determine which way the teacher needs to go to find ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31657"></a>31657</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Are ERIC and this teacher in the same location?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31658"></a>31658</td>
<td class="instruction">JR Z,31664</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31660"></a>31660</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Is this teacher going up or down a staircase?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31662"></a>31662</td>
<td class="instruction">JR C,31695</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31664"></a>31664</td>
<td class="instruction">LD L,122</td>
<td class="comment-11" rowspan="3">If this teacher's command list has been marked for a restart (by the routine at <a class="link" href="26342.html">26342</a>), terminate this interruptible subcommand and restart now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31666"></a>31666</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31668"></a>31668</td>
<td class="instruction">JP NZ,<a class="link" href="25248.html#25252">25252</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31671"></a>31671</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31672"></a>31672</td>
<td class="instruction">CALL <a class="link" href="31188.html">31188</a></td>
<td class="comment-11" rowspan="1">Check whether ERIC is where he should be</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31675"></a>31675</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31676"></a>31676</td>
<td class="instruction">JR NZ,31695</td>
<td class="comment-11" rowspan="1">Jump if ERIC is not where he should be</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31678"></a>
<div class="comments">
<div class="paragraph">
ERIC is back where he should be, so it's time for the teacher to resume his classroom duties.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31678"></a>31678</td>
<td class="instruction">LD L,117</td>
<td class="comment-11" rowspan="4">Pick up in <span class="register">DE</span> the address the teacher has reached in his command list</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31680"></a>31680</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31681"></a>31681</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31682"></a>31682</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31683"></a>31683</td>
<td class="instruction">LD B,2</td>
<td class="comment-11" rowspan="6">190 is the LSB of the address of the routine at <a class="link" href="25534.html">25534</a>; point <span class="register">DE</span> at the second-from-last occurrence of this routine address in the teacher's command list (which will take him to the side of the blackboard where he waits for EINSTEIN to grass, or back to the dinner hall)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31685"></a>31685</td>
<td class="instruction">DEC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31686"></a>31686</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31687"></a>31687</td>
<td class="instruction">CP 190</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31689"></a>31689</td>
<td class="instruction">JR NZ,31685</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31691"></a>31691</td>
<td class="instruction">DJNZ 31685</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31693"></a>31693</td>
<td class="instruction">JR <a class="link" href="31638.html">31638</a></td>
<td class="comment-11" rowspan="1">Restart the teacher's command list from this point</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31695"></a>
<div class="comments">
<div class="paragraph">
ERIC is not where he should be, or the teacher is on a staircase.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31695"></a>31695</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Are ERIC and the teacher in exactly the same location?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31696"></a>31696</td>
<td class="instruction">JR NZ,31711</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31698"></a>31698</td>
<td class="instruction">LD A,(23672)</td>
<td class="comment-11" rowspan="1">23672=LSB of FRAMES system variable</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31701"></a>31701</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">This LSB will be 0 once every 5.12 seconds</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31702"></a>31702</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if it's not zero now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31703"></a>31703</td>
<td class="instruction">CALL <a class="link" href="25108.html">25108</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the teacher's current animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31706"></a>31706</td>
<td class="instruction">XOR 128</td>
<td class="comment-11" rowspan="1">Make the teacher turn round</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31708"></a>31708</td>
<td class="instruction">JP <a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31711"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="63374.html">63374</a> with <span class="register">H</span> holding the number of a character looking for ERIC (which will be little boy no. 10 or a teacher), and <span class="register">A</span> holding 1, 2, 3 or 4 (indicating the character's next move).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31711"></a>31711</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Set the carry flag if the chaser is on a staircase</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31713"></a>31713</td>
<td class="instruction">LD BC,0</td>
<td class="comment-11" rowspan="2"><span class="register">DE</span> will hold the appropriate x- and y-coordinate increments for the chaser's next move (to the midstride position), and <span class="register">BC</span> will hold the appropriate x- and y-coordinate increments for the chaser's move after that (from the midstride position); initialise these increments to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31716"></a>31716</td>
<td class="instruction">LD DE,0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31719"></a>31719</td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="1">Byte 96 of the buffer holds the animatory state of ERIC's chaser</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31721"></a>31721</td>
<td class="instruction">JR C,<a class="link" href="31768.html">31768</a></td>
<td class="comment-11" rowspan="1">Jump if the chaser is currently going up or down stairs</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31723"></a>31723</td>
<td class="instruction">JR NZ,31732</td>
<td class="comment-11" rowspan="1">Jump if the chaser must go right (<span class="register">A</span>=4)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31725"></a>31725</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the chaser facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31727"></a>31727</td>
<td class="instruction">JR NZ,31703</td>
<td class="comment-11" rowspan="1">Turn him round if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31729"></a>31729</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=-1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31730"></a>31730</td>
<td class="instruction">JR <a class="link" href="31768.html#31781">31781</a></td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31732"></a>31732</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the chaser facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31734"></a>31734</td>
<td class="instruction">JR Z,31703</td>
<td class="comment-11" rowspan="1">Turn him round if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31736"></a>31736</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31737"></a>31737</td>
<td class="instruction">JR <a class="link" href="31768.html#31781">31781</a></td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31638.html">31638</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31648">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31739.html">31739</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>