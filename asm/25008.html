<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 25008</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24993.html">24993</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25008">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25106.html">25106</a></span></td>
</tr>
</table>
<div class="description">25008: Update a character's animatory state and location and update the SRB</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by many routines. Sets the new animatory state and location of a character, and updates the <a class="link" href="32524.html">screen refresh buffer</a> (SRB) accordingly.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">New animatory state</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">New y-coordinate (154-169)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">New x-coordinate (0-95)</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (152-172)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25008"></a>25008</td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 96 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25010"></a>25010</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Set the new animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25011"></a>25011</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Store the new animatory state in <span class="register">B</span> for later</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25012"></a>25012</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=97</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25013"></a>25013</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-11" rowspan="1">Set the new y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25014"></a>25014</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=98</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25015"></a>25015</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-11" rowspan="1">Set the new x-coordinate</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25016"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="25108.html">25108</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25016"></a>25016</td>
<td class="instruction">LD A,(32512)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the skool on-screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25019"></a>25019</td>
<td class="instruction">SUB 3</td>
<td class="comment-11" rowspan="1">Is the far left of the skool in view?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25021"></a>25021</td>
<td class="instruction">JR C,25025</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25023"></a>25023</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Is the character off-screen to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25024"></a>25024</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so (SRB does not need updating)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25025"></a>25025</td>
<td class="instruction">ADD A,34</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25027"></a>25027</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Is the character off-screen to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25028"></a>25028</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return if so (SRB does not need updating)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25029"></a>25029</td>
<td class="instruction">SUB 32</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=character's screen x-coordinate: -2&lt;=<span class="register">A</span>&lt;=31</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25031"></a>25031</td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25032"></a>25032</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25033"></a>25033</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25034"></a>25034</td>
<td class="instruction">LD L,B</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=character's new animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25035"></a>25035</td>
<td class="instruction">LD H,173</td>
<td class="comment-11" rowspan="1">Pages 173-176 store UDG references for the left column of the sprites</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25037"></a>25037</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the left column of the sprite on-screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25039"></a>25039</td>
<td class="instruction">JR Z,25051</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25041"></a>25041</td>
<td class="instruction">LD H,177</td>
<td class="comment-11" rowspan="1">Pages 177-180 store UDG references for the middle column of the sprites</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25043"></a>25043</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">-1&lt;=<span class="register">A</span>&lt;=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25044"></a>25044</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Is the middle column of the sprite on-screen at the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25046"></a>25046</td>
<td class="instruction">JR Z,25051</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25048"></a>25048</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25049"></a>25049</td>
<td class="instruction">LD H,181</td>
<td class="comment-11" rowspan="1">Pages 181-184 store UDG references for the right column of the sprites</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25051"></a>
<div class="comments">
<div class="paragraph">
At this point, <span class="register">A</span> holds the leftmost column of the screen (0-31) occupied by the character's sprite, and <span class="register">H</span> holds the page number (173, 177, 181) corresponding to the leftmost column of the sprite that appears on-screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25051"></a>25051</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="7">Set the instruction at <a class="link" href="27008.html#27015">27015</a> to SET n,(HL) where n is the appropriate bit of the SRB byte that needs to be set</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25052"></a>25052</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25053"></a>25053</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25054"></a>25054</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25055"></a>25055</td>
<td class="instruction">AND 56</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25057"></a>25057</td>
<td class="instruction">ADD A,198</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25059"></a>25059</td>
<td class="instruction">LD (27016),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25062"></a>25062</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=8c (c=0-31: leftmost column of the screen occupied by the sprite)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25063"></a>25063</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25064"></a>25064</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25065"></a>25065</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25067"></a>25067</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25068"></a>25068</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's y-coordinate (155-169)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25069"></a>25069</td>
<td class="instruction">SUB 149</td>
<td class="comment-11" rowspan="1">5&lt;=<span class="register">A</span>&lt;=20</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25071"></a>25071</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=4*(<span class="register">D</span>-149)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25072"></a>25072</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25073"></a>25073</td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=4*(<span class="register">D</span>-149)+INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25074"></a>25074</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=12+4*(<span class="register">D</span>-152)+INT(c/8)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25075"></a>25075</td>
<td class="instruction">LD D,127</td>
<td class="comment-11" rowspan="2">Now <span class="register">HL</span> points to the relevant byte of the <a class="link" href="32524.html">SRB</a>, and <span class="register">DE</span> points to the base address of the sprite UDG references</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25077"></a>25077</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25078"></a>25078</td>
<td class="instruction">CALL <a class="link" href="27008.html">27008</a></td>
<td class="comment-11" rowspan="1">Update the SRB for one column of the character's sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25081"></a>25081</td>
<td class="instruction">JR NZ,25104</td>
<td class="comment-11" rowspan="1">Jump if we just updated the SRB for the right column of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25083"></a>25083</td>
<td class="instruction">SUB 16</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> back to the relevant byte of the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25085"></a>25085</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25086"></a>25086</td>
<td class="instruction">LD A,(27016)</td>
<td class="comment-11" rowspan="2">Prepare to change the instruction at <a class="link" href="27008.html#27015">27015</a> from SET n,(HL) to SET n+1,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25089"></a>25089</td>
<td class="instruction">ADD A,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25091"></a>25091</td>
<td class="instruction">LD (27016),A</td>
<td class="comment-11" rowspan="1">Change the instruction at <a class="link" href="27008.html#27015">27015</a> from SET n,(HL) to SET n+1,(HL) or SET 0,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25094"></a>25094</td>
<td class="instruction">JR NC,25078</td>
<td class="comment-11" rowspan="1">Jump back unless the instruction at <a class="link" href="27008.html#27015">27015</a> should be changed to SET 0,(HL) now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25096"></a>25096</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move to the next byte of the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25097"></a>25097</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2">The zero flag will be set now if we 'wrapped around' to the left side of the screen, i.e. the next column of the character sprite is off-screen to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25098"></a>25098</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25100"></a>25100</td>
<td class="instruction">LD A,198</td>
<td class="comment-11" rowspan="1">This will change the instruction at <a class="link" href="27008.html#27015">27015</a> to SET 0,(HL)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25102"></a>25102</td>
<td class="instruction">JR NZ,25091</td>
<td class="comment-11" rowspan="1">Jump back to consider the remaining on-screen columns of the sprite</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25104"></a>25104</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the character number (152-172) to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25105"></a>25105</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24993.html">24993</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25008">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25106.html">25106</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20150413</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>