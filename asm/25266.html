<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 25266</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25248.html">25248</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25266">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25303.html">25303</a></span></td>
</tr>
</table>
<div class="description">25266: Determine whether a character should be moved (1)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="25126.html">25126</a>. Returns to that routine if the character under consideration should be moved on this pass; otherwise drops the return address from the stack, thus skipping ahead to consider the next character. Also reinitialises the walking speed change delay counter in byte 123 of the character's buffer when it reaches 0, and sets the new walking speed as appropriate: slow for teachers, fast or slow (at random) for boys.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (152-171)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25266"></a>25266</td>
<td class="instruction">LD L,123</td>
<td class="comment-11" rowspan="2">Byte 123 contains a counter that is reset to a random even number between 2 and 32; see below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25268"></a>25268</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25269"></a>25269</td>
<td class="instruction">JR Z,25280</td>
<td class="comment-11" rowspan="1">Jump if it's time to consider a change of pace</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25271"></a>25271</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-11" rowspan="1">Is the counter even?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25273"></a>25273</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (to move the character) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25274"></a>25274</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=122</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25275"></a>25275</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is this character walking fast?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25277"></a>25277</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return (to move the character) if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25278"></a>25278</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Drop the return address from the stack so that the character will not be moved this time round</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25279"></a>25279</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return to consider the next character, or return to the main loop</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="25280"></a>
<div class="comments">
<div class="paragraph">
It's time to consider a change of pace for the character being moved.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="25280"></a>25280</td>
<td class="instruction">CALL <a class="link" href="24993.html">24993</a></td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=random number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25283"></a>25283</td>
<td class="instruction">AND 61</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=even number between 2 and 32, and the carry flag holds a random bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25285"></a>25285</td>
<td class="instruction">ADD A,4</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25287"></a>25287</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25288"></a>25288</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Place this even number into byte 123 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25289"></a>25289</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=122</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25290"></a>25290</td>
<td class="instruction">RL (HL)</td>
<td class="comment-11" rowspan="2">Bit 7 of byte 122 is now equal to the random bit that was pushed into the carry flag by the RRA instruction above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25292"></a>25292</td>
<td class="instruction">RRC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25294"></a>25294</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Bit 5 of byte 122 is set for catapult pellets and stampeding boys to ensure they always go at top speed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25295"></a>25295</td>
<td class="instruction">BIT 5,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25297"></a>25297</td>
<td class="instruction">JR Z,<a class="link" href="25367.html">25367</a></td>
<td class="comment-11" rowspan="1">Jump if we're not dealing with such a thing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25299"></a>25299</td>
<td class="instruction">RES 7,(HL)</td>
<td class="comment-11" rowspan="1">Signal: fly or run at top speed</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="25301"></a>25301</td>
<td class="instruction">JR <a class="link" href="25367.html">25367</a></td>
<td class="comment-11" rowspan="1">Jump over the routine at <a class="link" href="25303.html">25303</a></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="25248.html">25248</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#25266">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="25303.html">25303</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>