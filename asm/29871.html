<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 29871</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29868.html">29868</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29871">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29972.html">29972</a></span></td>
</tr>
</table>
<div class="description">29871: Save the area of the screen that will be overwritten by a lines bubble</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="30464.html">30464</a> and <a class="link" href="63829.html">63829</a>. Returns with the carry flag set if the teacher whose coordinates are in <span class="register">DE</span> is off-screen. Otherwise calculates the position of the lines bubble and copies the area of the screen that would be overwritten by the bubble to the buffer at <a class="link" href="59904.html">59904</a>, and returns with <span class="register">DE</span> holding the attribute file address for the top-left corner of the lines bubble.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Teacher's coordinates</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29871"></a>29871</td>
<td class="instruction">LD A,(32512)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29874"></a>29874</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29875"></a>29875</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29876"></a>29876</td>
<td class="instruction">AND 248</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29878"></a>29878</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1">Is the teacher off-screen to the left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29879"></a>29879</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the carry flag set if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29880"></a>29880</td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">Is the teacher off-screen to the right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29882"></a>29882</td>
<td class="instruction">CCF</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29883"></a>29883</td>
<td class="instruction">RET C</td>
<td class="comment-11" rowspan="1">Return with the carry flag set if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29884"></a>
<div class="comments">
<div class="paragraph">
The teacher is on screen. First, save the attribute bytes of the area of the screen that will be overwritten by the lines bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29884"></a>29884</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=teacher's screen x-coordinate (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29885"></a>29885</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=teacher's y-coordinate (152-169)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29886"></a>29886</td>
<td class="instruction">SUB 155</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=teacher's screen y-coordinate (0-14)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29888"></a>29888</td>
<td class="instruction">JR NC,29891</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29890"></a>29890</td>
<td class="instruction">XOR A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29891"></a>29891</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="11">Set <span class="register">DE</span> to the attribute file address of the top left corner of the lines bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29892"></a>29892</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29893"></a>29893</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29894"></a>29894</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29895"></a>29895</td>
<td class="instruction">AND 224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29897"></a>29897</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29898"></a>29898</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29899"></a>29899</td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29900"></a>29900</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29902"></a>29902</td>
<td class="instruction">ADD A,88</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29904"></a>29904</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29905"></a>29905</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29906"></a>29906</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29907"></a>29907</td>
<td class="instruction">LD HL,59904</td>
<td class="comment-11" rowspan="1">The buffer at <a class="link" href="59904.html">59904</a> will store the area of the screen overwritten by the lines bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29910"></a>29910</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=<a class="link" href="59904.html">59904</a>, <span class="register">HL</span>=attribute file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29911"></a>29911</td>
<td class="instruction">LD BC,8</td>
<td class="comment-11" rowspan="10">Copy the 24 attribute bytes that will be overwritten by the lines bubble from the screen to <a class="link" href="59904.html">59904</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29914"></a>29914</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29916"></a>29916</td>
<td class="instruction">LD C,24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29918"></a>29918</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29919"></a>29919</td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29921"></a>29921</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29923"></a>29923</td>
<td class="instruction">LD C,24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29925"></a>29925</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29926"></a>29926</td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29928"></a>29928</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29930"></a>
<div class="comments">
<div class="paragraph">
Next, save the display file bytes of the area of the screen that will be overwritten by the lines bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29930"></a>29930</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="2">Restore the attribute file address of the top-left corner of the lines bubble to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29931"></a>29931</td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29932"></a>29932</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="6">Get the display file address of the top-left corner of the lines bubble in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29933"></a>29933</td>
<td class="instruction">SUB 80</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29935"></a>29935</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29936"></a>29936</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29937"></a>29937</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29938"></a>29938</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29939"></a>29939</td>
<td class="instruction">LD BC,3</td>
<td class="comment-11" rowspan="1">A lines bubble has 3 rows...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29942"></a>29942</td>
<td class="instruction">LD A,8</td>
<td class="comment-11" rowspan="19">...and 8 columns; copy the 192 display file bytes that will be overwritten by the lines bubble from the screen to <a class="link" href="59904.html#59928">59928</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29944"></a>29944</td>
<td class="instruction">PUSH BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29945"></a>29945</td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29946"></a>29946</td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29948"></a>29948</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29950"></a>29950</td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29951"></a>29951</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29952"></a>29952</td>
<td class="instruction">DEC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29953"></a>29953</td>
<td class="instruction">JR NZ,29945</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29955"></a>29955</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29956"></a>29956</td>
<td class="instruction">ADD A,32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29958"></a>29958</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29959"></a>29959</td>
<td class="instruction">JR C,29965</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29961"></a>29961</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29962"></a>29962</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29964"></a>29964</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29965"></a>29965</td>
<td class="instruction">POP BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29966"></a>29966</td>
<td class="instruction">DEC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29967"></a>29967</td>
<td class="instruction">JR NZ,29942</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29969"></a>29969</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the attribute file address of the top-left corner of the lines bubble to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29970"></a>29970</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29971"></a>29971</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">Return with the carry flag reset</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29868.html">29868</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29871">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29972.html">29972</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>