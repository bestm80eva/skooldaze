<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 24843</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24832.html">24832</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24843">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24963.html">24963</a></span></td>
</tr>
</table>
<div class="description">24843: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="24576.html">24576</a> and <a class="link" href="27026.html">27026</a>. Copies a tile of the skool into the back buffer at <a class="link" href="32513.html">32513</a>, superimposes character sprite tiles as appropriate, and then copies the resultant tile to the screen.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Skool x-coordinate (0-95)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24843"></a>24843</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=skool x-coordinate (0-95)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24844"></a>24844</td>
<td class="instruction">AND 96</td>
<td class="comment-11" rowspan="5">Now <span class="register">H</span> is 128 if 0&lt;=<span class="register">E</span>&lt;32; 136 if 32&lt;=<span class="register">E</span>&lt;64; or 144 if 64&lt;=<span class="register">E</span>&lt;96</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24846"></a>24846</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24847"></a>24847</td>
<td class="instruction">INC A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24848"></a>24848</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24849"></a>24849</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24850"></a>24850</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=skool UDG reference for the character square at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24851"></a>24851</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24852"></a>24852</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=base address of the UDG bytes for the character square at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24853"></a>24853</td>
<td class="instruction">LD BC,2048</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=8, <span class="register">C</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24856"></a>24856</td>
<td class="instruction">LD DE,32513</td>
<td class="comment-11" rowspan="6">Copy the 8 bytes of the skool UDG into the back buffer at <a class="link" href="32513.html">32513</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24859"></a>24859</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24860"></a>24860</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24861"></a>24861</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24862"></a>24862</td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24863"></a>24863</td>
<td class="instruction">DJNZ 24859</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24865"></a>24865</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24866"></a>24866</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the skool coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24867"></a>24867</td>
<td class="instruction">LD B,21</td>
<td class="comment-11" rowspan="1">There are 21 characters to consider</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24869"></a>24869</td>
<td class="instruction">LD H,152</td>
<td class="comment-11" rowspan="1">152=little boy no. 1</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24871"></a>
<div class="comments">
<div class="paragraph">
Now we enter a loop that checks which part (if any) of each character's sprite appears at the skool coordinates in <span class="register">DE</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24871"></a>24871</td>
<td class="instruction">LD L,98</td>
<td class="comment-11" rowspan="1">Byte 98 of the character's buffer holds his x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24873"></a>24873</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=skool x-coordinate (0-95)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24874"></a>24874</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24875"></a>24875</td>
<td class="instruction">DEC HL</td>
<td class="comment-11" rowspan="1">Byte 97 of the character's buffer holds his y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24876"></a>24876</td>
<td class="instruction">JR C,24926</td>
<td class="comment-11" rowspan="3">Jump if no part of the character's sprite appears at this x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24878"></a>24878</td>
<td class="instruction">CP 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24880"></a>24880</td>
<td class="instruction">JR NC,24926</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24882"></a>24882</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="3">Now <span class="register">C</span> is 0, 4 or 8, corresponding to the column (left, middle or right) of the character's sprite that aligns with x-coordinate <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24883"></a>24883</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24884"></a>24884</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24885"></a>24885</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24886"></a>24886</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24887"></a>24887</td>
<td class="instruction">JR C,24926</td>
<td class="comment-11" rowspan="3">Jump if no part of the character's sprite appears at this y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24889"></a>24889</td>
<td class="instruction">CP 4</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24891"></a>24891</td>
<td class="instruction">JR NC,24926</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24893"></a>24893</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0-11, corresponding to the sprite tile that appears at (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24894"></a>24894</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24895"></a>24895</td>
<td class="instruction">ADD A,173</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24897"></a>24897</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="1"><span class="register">H'</span>=173-184</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24898"></a>24898</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24899"></a>24899</td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="2">Pick up the character's animatory state in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24901"></a>24901</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24902"></a>24902</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24903"></a>24903</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L'</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24904"></a>24904</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=sprite tile UDG reference</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24905"></a>24905</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is it the blank UDG?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24906"></a>24906</td>
<td class="instruction">JR Z,24925</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24908"></a>24908</td>
<td class="instruction">CALL <a class="link" href="27914.html">27914</a></td>
<td class="comment-11" rowspan="1">Get the base address of the sprite tile UDG bytes in <span class="register">HL'</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24911"></a>
<div class="comments">
<div class="paragraph">
The following inner loop superimposes the sprite tile onto the tile built up so far in the back buffer at <a class="link" href="32513.html">32513</a> (which was originally populated with the relevant skool UDG).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24911"></a>24911</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are 8 bytes in the UDG</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24913"></a>24913</td>
<td class="instruction">LD DE,32513</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24916"></a>24916</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=back buffer UDG byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24917"></a>24917</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">OR in the sprite tile UDG byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24918"></a>24918</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24919"></a>24919</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND in the sprite tile UDG mask</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24920"></a>24920</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24921"></a>24921</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24922"></a>24922</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24923"></a>24923</td>
<td class="instruction">DJNZ 24916</td>
<td class="comment-11" rowspan="1">Jump back until the UDG is done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24925"></a>24925</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24926"></a>24926</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Next character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24927"></a>24927</td>
<td class="instruction">DJNZ 24871</td>
<td class="comment-11" rowspan="1">Jump back to consider the next character</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24929"></a>
<div class="comments">
<div class="paragraph">
The display tile (consisting of the skool UDG with all relevant sprite tiles superimposed) has been built. Figure out where in the display file it should be printed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24929"></a>24929</td>
<td class="instruction">LD HL,32512</td>
<td class="comment-11" rowspan="1"><a class="link" href="32512.html">32512</a> holds the leftmost column of the skool on-screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24932"></a>24932</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=skool y-coordinate (152-172)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24933"></a>24933</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="5">Set <span class="register">C</span> to the LSB of the display file address corresponding to the screen coordinates (0,<span class="register">D</span>-152)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24935"></a>24935</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24936"></a>24936</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24937"></a>24937</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24938"></a>24938</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24939"></a>24939</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=screen x-coordinate (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24940"></a>24940</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24941"></a>24941</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="2">Set <span class="register">L</span> to the LSB of the display file address corresponding to the skool coordinates (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24942"></a>24942</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24943"></a>24943</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=screen y-coordinate (0-20)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24944"></a>24944</td>
<td class="instruction">SUB 152</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24946"></a>24946</td>
<td class="instruction">AND 24</td>
<td class="comment-11" rowspan="3">Set <span class="register">H</span> to the MSB of the display file address corresponding to the skool coordinates (<span class="register">E</span>,<span class="register">D</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24948"></a>24948</td>
<td class="instruction">ADD A,64</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24950"></a>24950</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24951"></a>
<div class="comments">
<div class="paragraph">
Having computed the appropriate display file address in <span class="register">HL</span>, copy the tile from the back buffer to the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24951"></a>24951</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="7">Copy the tile to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24953"></a>24953</td>
<td class="instruction">LD DE,32513</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24956"></a>24956</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24957"></a>24957</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24958"></a>24958</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24959"></a>24959</td>
<td class="instruction">INC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24960"></a>24960</td>
<td class="instruction">DJNZ 24956</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24962"></a>24962</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24832.html">24832</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24843">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24963.html">24963</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>