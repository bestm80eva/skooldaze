<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 29160</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29153.html">29153</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29160">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29278.html">29278</a></span></td>
</tr>
</table>
<div class="description">29160: Make a teacher wipe a blackboard (2)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Continues from <a class="link" href="29148.html">29148</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Blackboard identifier (236, 238 or 240)</td>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates of the top-left corner of the blackboard</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Teacher's character number (163-166)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29160"></a>29160</td>
<td class="instruction">LD L,105</td>
<td class="comment-11" rowspan="2">Replace the address of the interruptible subcommand routine at <a class="link" href="29148.html">29148</a> in bytes 105 and 106 of the teacher's buffer with <a class="link" href="29160.html#29175">29175</a> (below)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29162"></a>29162</td>
<td class="instruction">LD (HL),247</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29164"></a>29164</td>
<td class="instruction">LD L,107</td>
<td class="comment-11" rowspan="2">Wiping a blackboard requires 32 distinct actions (in 8 groups of 4: two paces forward, arm up, arm down)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29166"></a>29166</td>
<td class="instruction">LD (HL),32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29168"></a>29168</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="4">Store the x-coordinate of the rightmost column of the blackboard (which will be wiped first) in byte 108 of the teacher's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29169"></a>29169</td>
<td class="instruction">LD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29170"></a>29170</td>
<td class="instruction">ADD A,7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29172"></a>29172</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29173"></a>29173</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Store the y-coordinate of the top row of the blackboard in byte 109 of the teacher's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29174"></a>29174</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29175"></a>
<div class="comments">
<div class="paragraph">
After the initial call to this routine, each subsequent call enters here.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29175"></a>29175</td>
<td class="instruction">LD L,107</td>
<td class="comment-11" rowspan="2">Decrement the number of board-wiping actions remaining</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29177"></a>29177</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29178"></a>29178</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Has the teacher finished wiping the board?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29180"></a>29180</td>
<td class="instruction">JR NZ,29264</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29182"></a>29182</td>
<td class="instruction">CALL <a class="link" href="25108.html">25108</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the teacher's current location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29185"></a>29185</td>
<td class="instruction">LD L,107</td>
<td class="comment-11" rowspan="2">Is the teacher midstride or is his arm raised?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29187"></a>29187</td>
<td class="instruction">BIT 0,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29189"></a>29189</td>
<td class="instruction">JR Z,29248</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29191"></a>29191</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-11" rowspan="1">Is the teacher ready to raise his arm (and wipe)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29193"></a>29193</td>
<td class="instruction">JR Z,29199</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29195"></a>29195</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=animatory state of the teacher midstride</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29196"></a>29196</td>
<td class="instruction">JP <a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29199"></a>
<div class="comments">
<div class="paragraph">
The teacher is ready to raise his arm and wipe a column of the board.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29199"></a>29199</td>
<td class="instruction">ADD A,5</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=animatory state of the teacher with his arm raised</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29201"></a>29201</td>
<td class="instruction">CP 72</td>
<td class="comment-11" rowspan="1">Are we actually dealing with a teacher?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29203"></a>29203</td>
<td class="instruction">JR NC,29207</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29205"></a>29205</td>
<td class="instruction">ADD A,8</td>
<td class="comment-11" rowspan="1">If ANGELFACE or BOY WANDER were wiping the board, <span class="register">A</span> would now hold the animatory state of the boy with his arm raised</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29207"></a>29207</td>
<td class="instruction">CALL <a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the teacher's animatory state and update the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29210"></a>29210</td>
<td class="instruction">LD L,108</td>
<td class="comment-11" rowspan="2"><span class="register">E</span>=x-coordinate of the blackboard column to wipe</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29212"></a>29212</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29213"></a>29213</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1">Decrement the blackboard column x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29214"></a>29214</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2"><span class="register">D</span>=y-coordinate of the top row of the blackboard column to wipe</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29215"></a>29215</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29216"></a>29216</td>
<td class="instruction">CALL <a class="link" href="28807.html">28807</a></td>
<td class="comment-11" rowspan="3">Update the SRB for the upper and lower character squares of the blackboard column that will be wiped</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29219"></a>29219</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29220"></a>29220</td>
<td class="instruction">CALL <a class="link" href="28807.html">28807</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29223"></a>29223</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2"><span class="register">L</span>=skool UDG reference for the lower character square of the blackboard column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29224"></a>29224</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29225"></a>29225</td>
<td class="instruction">ADD A,8</td>
<td class="comment-11" rowspan="2"><span class="register">E</span>=skool UDG reference for the upper character square of the blackboard column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29227"></a>29227</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29228"></a>29228</td>
<td class="instruction">LD H,128</td>
<td class="comment-11" rowspan="5">Point <span class="register">HL</span> at the base address of the UDG data for the lower character square of the blackboard column, and <span class="register">DE</span> at the base address of the UDG data for the upper character square of the blackboard column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29230"></a>29230</td>
<td class="instruction">CP 233</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29232"></a>29232</td>
<td class="instruction">JR NC,29236</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29234"></a>29234</td>
<td class="instruction">LD H,136</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29236"></a>29236</td>
<td class="instruction">LD D,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29237"></a>29237</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are 8 bytes in a UDG</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29239"></a>29239</td>
<td class="instruction">LD A,255</td>
<td class="comment-11" rowspan="1">All bits set means clean (no chalk)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29241"></a>29241</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="5">Wipe the blackboard column clean by altering the skool UDG data directly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29242"></a>29242</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29243"></a>29243</td>
<td class="instruction">INC H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29244"></a>29244</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29245"></a>29245</td>
<td class="instruction">DJNZ 29241</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29247"></a>29247</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29248"></a>
<div class="comments">
<div class="paragraph">
The teacher is midstride or his arm is raised.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29248"></a>29248</td>
<td class="instruction">AND 248</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=base animatory state of the teacher</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29250"></a>29250</td>
<td class="instruction">CP 72</td>
<td class="comment-11" rowspan="1">Are we actually dealing with a teacher?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29252"></a>29252</td>
<td class="instruction">JR NC,29256</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29254"></a>29254</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">If ANGELFACE or BOY WANDER were wiping the board, <span class="register">A</span> would now hold the base animatory state of the boy</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29256"></a>29256</td>
<td class="instruction">BIT 1,(HL)</td>
<td class="comment-11" rowspan="1">Is the teacher's arm raised?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29258"></a>29258</td>
<td class="instruction">JR Z,29261</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29260"></a>29260</td>
<td class="instruction">DEC E</td>
<td class="comment-11" rowspan="1">The teacher was midstride, so move him forward to the next blackboard column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29261"></a>29261</td>
<td class="instruction">JP <a class="link" href="25008.html">25008</a></td>
<td class="comment-11" rowspan="1">Update the teacher's animatory state and location and update the SRB</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29264"></a>
<div class="comments">
<div class="paragraph">
The teacher has finished wiping the board.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29264"></a>29264</td>
<td class="instruction">CALL <a class="link" href="28968.html">28968</a></td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=identifier of the blackboard the teacher is next to</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29267"></a>29267</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="2"><span class="register">HL</span>=<a class="link" href="32748.html">32748</a> (Reading Room blackboard), <a class="link" href="32750.html">32750</a> (White Room blackboard), or <a class="link" href="32752.html">32752</a> (Exam Room blackboard)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29268"></a>29268</td>
<td class="instruction">LD H,127</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29270"></a>29270</td>
<td class="instruction">LD (HL),1</td>
<td class="comment-11" rowspan="1">The first clean pixel column is now column no. 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29272"></a>29272</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Signal: no one has written on this blackboard</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29273"></a>29273</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29275"></a>29275</td>
<td class="instruction">JP <a class="link" href="25248.html#25252">25252</a></td>
<td class="comment-11" rowspan="1">Terminate this interruptible subcommand</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29153.html">29153</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29160">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29278.html">29278</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20150413</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>