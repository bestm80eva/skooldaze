<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 26880</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="26836.html">26836</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26880">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27007.html">27007</a></span></td>
</tr>
</table>
<div class="description">26880: Start a new game or enter demo mode</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
This section of code is entered at various points. The main entry point below is used by the startup routine at <a class="link" href="../start/24288.html">24288</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26880"></a>26880</td>
<td class="instruction">LD SP,23806</td>
<td class="comment-11" rowspan="1">Put the stack pointer somewhere safe</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26883"></a>26883</td>
<td class="instruction">CALL <a class="link" href="32390.html">32390</a></td>
<td class="comment-11" rowspan="1">Play the theme tune</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26886"></a>26886</td>
<td class="instruction">JR 26902</td>
<td class="comment-11" rowspan="1">Enter demo mode</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26888"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="63990.html">63990</a> when ERIC has been sent home (either for having mumps or for having over 10000 lines).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26888"></a>26888</td>
<td class="instruction">CALL <a class="link" href="32470.html">32470</a></td>
<td class="comment-11" rowspan="1">Remove the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26891"></a>26891</td>
<td class="instruction">LD DE,(32708)</td>
<td class="comment-11" rowspan="1"><span class="register">DE</span>=score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26895"></a>26895</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Reset the carry flag ready for a subtraction</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26896"></a>26896</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">Subtract the score from the high score...</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26898"></a>26898</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="1">...and add it back again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26899"></a>26899</td>
<td class="instruction">JR NC,26902</td>
<td class="comment-11" rowspan="1">Jump unless we have a new high score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26901"></a>26901</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=new high score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26902"></a>26902</td>
<td class="instruction">LD A,255</td>
<td class="comment-11" rowspan="1">255: demo mode</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26904"></a>26904</td>
<td class="instruction">JR 26913</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26906"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="32250.html">32250</a> when exiting demo mode.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26906"></a>26906</td>
<td class="instruction">CALL <a class="link" href="60896.html">60896</a></td>
<td class="comment-11" rowspan="1">Ask for the input method, and change the character names (if desired)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26909"></a>26909</td>
<td class="instruction">LD HL,(32706)</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=high score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26912"></a>26912</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">0: game mode (as opposed to demo mode)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26913"></a>26913</td>
<td class="instruction">LD SP,23806</td>
<td class="comment-11" rowspan="1">Put the stack pointer somewhere safe</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26916"></a>26916</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the high score</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26917"></a>26917</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=255 (demo mode) or 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26918"></a>26918</td>
<td class="instruction">LD A,(32761)</td>
<td class="comment-11" rowspan="1">Collect the current lesson number (0-63) from <a class="link" href="32761.html">32761</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26921"></a>26921</td>
<td class="instruction">AND 48</td>
<td class="comment-11" rowspan="2">Set <span class="register">A</span> to 15, 31, 47 or 63 (lessons 0, 16, 32, and 48 are PLAYTIME)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26923"></a>26923</td>
<td class="instruction">ADD A,15</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26925"></a>26925</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=new lesson number minus one</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26926"></a>26926</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save this for now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26927"></a>26927</td>
<td class="instruction">CALL <a class="link" href="63242.html">63242</a></td>
<td class="comment-11" rowspan="1">Unflash the safe and all shields</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26930"></a>26930</td>
<td class="instruction">LD HL,32765</td>
<td class="comment-11" rowspan="1"><a class="link" href="32765.html">32765</a> holds the number (152-171) of the last character moved</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26933"></a>26933</td>
<td class="instruction">LD (HL),151</td>
<td class="comment-11" rowspan="1">Reset this number so 152 (little boy no. 1) is moved next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26935"></a>26935</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="3">Blank out the rest of the game status buffer (except for the random number seed at <a class="link" href="32766.html">32766</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26936"></a>26936</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26938"></a>26938</td>
<td class="instruction">JR NZ,26935</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26940"></a>26940</td>
<td class="instruction">LD L,232</td>
<td class="comment-11" rowspan="2">Initialise ERIC's main action timer at <a class="link" href="32744.html">32744</a> to 17</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26942"></a>26942</td>
<td class="instruction">LD (HL),17</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26944"></a>26944</td>
<td class="instruction">LD L,249</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=<a class="link" href="32761.html">32761</a> (which holds the lesson number, 0-63)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26946"></a>26946</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the lesson number to <span class="register">D</span> and game mode indicator (0 or 255) to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26947"></a>26947</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-11" rowspan="1">Set the lesson number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26948"></a>26948</td>
<td class="instruction">LD L,247</td>
<td class="comment-11" rowspan="2">Set the lesson clock (at <a class="link" href="32759.html">32759</a>) to 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26950"></a>26950</td>
<td class="instruction">INC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26951"></a>26951</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="2">If a new game is starting, prepare the shields and safe, and play the theme tune</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26952"></a>26952</td>
<td class="instruction">CALL NZ,<a class="link" href="63668.html">63668</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26955"></a>26955</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="2">Restore the high score to <span class="register">HL</span>, and save it in <a class="link" href="32706.html">32706</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26956"></a>26956</td>
<td class="instruction">LD (32706),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="26959"></a>
<div class="comments">
<div class="paragraph">
The following loop sets the initial animatory state, location and character flags (byte 122 of the buffer) for each character (including ERIC).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26959"></a>26959</td>
<td class="instruction">LD H,152</td>
<td class="comment-11" rowspan="1">152=little boy no. 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26961"></a>26961</td>
<td class="instruction">LD DE,56064</td>
<td class="comment-11" rowspan="1">The data table at <a class="link" href="56064.html">56064</a> holds the initial animatory states of the characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26964"></a>26964</td>
<td class="instruction">LD L,96</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 96 of the character buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26966"></a>26966</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Set the initial animatory state of the character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26967"></a>26967</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26968"></a>26968</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=97</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26969"></a>26969</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">The data table at <a class="link" href="56320.html">56320</a> holds the initial x-coordinates of the characters</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26970"></a>26970</td>
<td class="instruction">LD (HL),169</td>
<td class="comment-11" rowspan="1">All characters start on the bottom floor (y=169)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26972"></a>26972</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=98</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26973"></a>26973</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the character's initial x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26974"></a>26974</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">The data table at <a class="link" href="56576.html">56576</a> holds the character flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26975"></a>26975</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Set the character's initial x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26976"></a>26976</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the character flags (0=kid; 16=adult; 32=pellet)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26977"></a>26977</td>
<td class="instruction">DEC D</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> back at the table of initial animatory states</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26978"></a>26978</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26979"></a>26979</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Next character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26980"></a>26980</td>
<td class="instruction">LD B,29</td>
<td class="comment-11" rowspan="4">Blank out the remaining 29 bytes of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="26982"></a>26982</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26983"></a>26983</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26985"></a>26985</td>
<td class="instruction">DJNZ 26982</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26987"></a>26987</td>
<td class="instruction">LD L,122</td>
<td class="comment-11" rowspan="2">Place the character flags into byte 122 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26989"></a>26989</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26990"></a>26990</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26991"></a>26991</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=124</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26992"></a>26992</td>
<td class="instruction">LD (HL),159</td>
<td class="comment-11" rowspan="3">Place the address of the continual subcommand routine at <a class="link" href="25126.html#25247">25247</a> (RET) into bytes 124 and 125 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26994"></a>26994</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26995"></a>26995</td>
<td class="instruction">LD (HL),98</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26997"></a>26997</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Next character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26998"></a>26998</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1">Have we done all the non-player characters?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="26999"></a>26999</td>
<td class="instruction">JR NZ,26964</td>
<td class="comment-11" rowspan="1">Jump back to do the next one if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27001"></a>
<div class="comments">
<div class="paragraph">
All that remains now is to print the logo, lesson box and score box, and bring the skool into view.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27001"></a>27001</td>
<td class="instruction">CALL <a class="link" href="27406.html">27406</a></td>
<td class="comment-11" rowspan="1">Print the bottom 3 lines of the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27004"></a>27004</td>
<td class="instruction">JP <a class="link" href="63768.html">63768</a></td>
<td class="comment-11" rowspan="1">Scroll the skool into view and enter the main loop</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="26836.html">26836</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26880">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27007.html">27007</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>