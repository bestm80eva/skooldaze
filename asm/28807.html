<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 28807</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="28802.html">28802</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#28807">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28882.html">28882</a></span></td>
</tr>
</table>
<div class="description">28807: Update the SRB for a blackboard or the speech bubble lip</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="28994.html">28994</a>, <a class="link" href="29160.html">29160</a>, <a class="link" href="29518.html">29518</a> and <a class="link" href="29746.html">29746</a>. Updates the <a class="link" href="32524.html">screen refresh buffer</a> (SRB) so that the character squares at (<span class="register">E</span>,<span class="register">D</span>) and (<span class="register">E</span>+1,<span class="register">D</span>) are marked dirty. Two character squares in a row are marked dirty to ensure that blackboard contents are properly displayed (characters written on a blackboard may cross character square boundaries).
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Skool y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Skool x-coordinate</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28807"></a>28807</td>
<td class="instruction">LD A,(32512)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=X: leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28810"></a>28810</td>
<td class="instruction">SUB 2</td>
<td class="comment-11" rowspan="7">Return unless X-1&lt;=<span class="register">E</span>&lt;=X+31 (i.e. unless the coordinates in <span class="register">DE</span> correspond to a skool location that is currently on-screen or just off to the left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28812"></a>28812</td>
<td class="instruction">JR C,28816</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28814"></a>28814</td>
<td class="instruction">CP E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28815"></a>28815</td>
<td class="instruction">RET NC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28816"></a>28816</td>
<td class="instruction">ADD A,33</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28818"></a>28818</td>
<td class="instruction">CP E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28819"></a>28819</td>
<td class="instruction">RET C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28820"></a>28820</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Store the skool coordinates</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28821"></a>28821</td>
<td class="instruction">SUB 32</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=<span class="register">E</span>-X (-1, 0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28823"></a>28823</td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28824"></a>28824</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28825"></a>28825</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="1">Are the coordinates in <span class="register">DE</span> on-screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28827"></a>28827</td>
<td class="instruction">JR Z,28830</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28829"></a>28829</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28830"></a>28830</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=8x (x=0-31, the screen x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28831"></a>28831</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28832"></a>28832</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28833"></a>28833</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Save this value in <span class="register">E</span> briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28834"></a>28834</td>
<td class="instruction">AND 56</td>
<td class="comment-11" rowspan="3">Modify the SET m,(HL) instruction at <a class="link" href="28807.html#28857">28857</a> below</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28836"></a>28836</td>
<td class="instruction">ADD A,198</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28838"></a>28838</td>
<td class="instruction">LD (28858),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28841"></a>28841</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="13">Point <span class="register">HL</span> at the appropriate byte in the screen refresh buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28842"></a>28842</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28843"></a>28843</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28844"></a>28844</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28846"></a>28846</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28847"></a>28847</td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28848"></a>28848</td>
<td class="instruction">SUB 149</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28850"></a>28850</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28851"></a>28851</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28852"></a>28852</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28853"></a>28853</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28854"></a>28854</td>
<td class="instruction">LD D,127</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28856"></a>28856</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28857"></a>28857</td>
<td class="instruction">SET 0,(HL)</td>
<td class="comment-11" rowspan="1">Set the appropriate bit in the SRB byte; this instruction is modified earlier in this routine to set the required bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28859"></a>28859</td>
<td class="instruction">LD A,(28858)</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28862"></a>28862</td>
<td class="instruction">ADD A,8</td>
<td class="comment-11" rowspan="1">Was m=7?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28864"></a>28864</td>
<td class="instruction">JR NC,28874</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28866"></a>28866</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move to the next SRB byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28867"></a>28867</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="2"><span class="register">A</span> will be 0 if we wrapped round to the next row of the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28868"></a>28868</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28870"></a>28870</td>
<td class="instruction">LD A,198</td>
<td class="comment-11" rowspan="1">198 will set n=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28872"></a>28872</td>
<td class="instruction">JR Z,28879</td>
<td class="comment-11" rowspan="1">Jump if we wrapped round to the next row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28874"></a>28874</td>
<td class="instruction">LD (28878),A</td>
<td class="comment-11" rowspan="1">Modify the SET n,(HL) instruction below so that n=m+1 mod 8</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28877"></a>28877</td>
<td class="instruction">SET 0,(HL)</td>
<td class="comment-11" rowspan="1">Set the appropriate bit in the SRB byte; this instruction is modified immediately before execution to set the required bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="28879"></a>28879</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28880"></a>28880</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the skool coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28881"></a>28881</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="28802.html">28802</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#28807">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28882.html">28882</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20140614</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>