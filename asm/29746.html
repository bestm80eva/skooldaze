<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Skool Daze: Routine at 29746</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../sd.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Skool Daze" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29735.html">29735</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29746">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29868.html">29868</a></span></td>
</tr>
</table>
<div class="description">29746: Remove the speech bubble</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="31130.html">31130</a> and <a class="link" href="32470.html">32470</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the character who is speaking (152-169)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29746"></a>29746</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Save the character number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29747"></a>29747</td>
<td class="instruction">CALL <a class="link" href="29394.html">29394</a></td>
<td class="comment-11" rowspan="1">Is the speech bubble off-screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29750"></a>29750</td>
<td class="instruction">JR C,29815</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29752"></a>29752</td>
<td class="instruction">CALL <a class="link" href="29735.html">29735</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the part of the screen hidden by the speech bubble</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29755"></a>
<div class="comments">
<div class="paragraph">
First, restore the original attribute bytes for the area of the screen occupied by the speech bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29755"></a>29755</td>
<td class="instruction">LD DE,(32612)</td>
<td class="comment-11" rowspan="1">Copy the speech bubble lip coordinates from <a class="link" href="32612.html">32612</a> to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29759"></a>29759</td>
<td class="instruction">CALL <a class="link" href="28807.html">28807</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the part of the screen hidden by the lip</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29762"></a>29762</td>
<td class="instruction">LD HL,32512</td>
<td class="comment-11" rowspan="1"><a class="link" href="32512.html">32512</a> holds the leftmost column of the skool on screen (0-64)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29765"></a>29765</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="3"><span class="register">E</span>=screen x-coordinate of the speech bubble lip (0-31)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29766"></a>29766</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29767"></a>29767</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29768"></a>29768</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=screen y-coordinate of the speech bubble lip (2-17)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29769"></a>29769</td>
<td class="instruction">SUB 152</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29771"></a>29771</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="11">Set <span class="register">DE</span> to the attribute file address corresponding to the lip of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29772"></a>29772</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29773"></a>29773</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29774"></a>29774</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29775"></a>29775</td>
<td class="instruction">AND 224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29777"></a>29777</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29778"></a>29778</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29779"></a>29779</td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29780"></a>29780</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29782"></a>29782</td>
<td class="instruction">ADD A,88</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29784"></a>29784</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29785"></a>29785</td>
<td class="instruction">LD L,103</td>
<td class="comment-11" rowspan="3">Pick up the attribute byte for the part of screen hidden by the speech bubble lip from <a class="link" href="32614.html#32615">32615</a> and restore it to the attribute file</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29787"></a>29787</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29788"></a>29788</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29789"></a>29789</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="7">Point <span class="register">DE</span> at the attribute file address corresponding to the top left corner of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29790"></a>29790</td>
<td class="instruction">LD BC,65472</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29793"></a>29793</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29794"></a>29794</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29795"></a>29795</td>
<td class="instruction">AND 248</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29797"></a>29797</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29798"></a>29798</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29799"></a>29799</td>
<td class="instruction">LD BC,8</td>
<td class="comment-11" rowspan="3">Restore the attribute bytes of the part of the screen overwritten by the top row of the speech bubble (stored at <a class="link" href="32614.html#32632">32632</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29802"></a>29802</td>
<td class="instruction">LD L,120</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29804"></a>29804</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29806"></a>29806</td>
<td class="instruction">LD C,24</td>
<td class="comment-11" rowspan="4">Point <span class="register">DE</span> at the attribute file address corresponding to the bottom left corner of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29808"></a>29808</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29809"></a>29809</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29810"></a>29810</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29811"></a>29811</td>
<td class="instruction">LD C,8</td>
<td class="comment-11" rowspan="2">Restore the attribute bytes of the part of the screen overwritten by the bottom row of the speech bubble (stored at <a class="link" href="32614.html#32640">32640</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29813"></a>29813</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29815"></a>
<div class="comments">
<div class="paragraph">
Next, restore the skool UDG references and attribute bytes for the area of the skool occupied by the speech bubble.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="29815"></a>29815</td>
<td class="instruction">LD DE,(32612)</td>
<td class="comment-11" rowspan="1">Copy the speech bubble lip coordinates from <a class="link" href="32612.html">32612</a> to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29819"></a>29819</td>
<td class="instruction">LD HL,32614</td>
<td class="comment-11" rowspan="4">Pick up the UDG reference for the part of the skool occupied by the speech bubble lip and restore it</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29822"></a>29822</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29823"></a>29823</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29824"></a>29824</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29825"></a>29825</td>
<td class="instruction">SET 7,E</td>
<td class="comment-11" rowspan="4">Pick up the attribute byte for the part of the skool occupied by the speech bubble lip and restore it</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29827"></a>29827</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29828"></a>29828</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29829"></a>29829</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29830"></a>29830</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="5"><span class="register">DE</span>=coordinates of the top left corner of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29831"></a>29831</td>
<td class="instruction">AND 120</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29833"></a>29833</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29834"></a>29834</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29835"></a>29835</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29836"></a>29836</td>
<td class="instruction">LD BC,8</td>
<td class="comment-11" rowspan="2">Restore the UDG references of the part of the skool overwritten by the top row of the speech bubble (stored at <a class="link" href="32614.html#32616">32616</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29839"></a>29839</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29841"></a>29841</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="4">Restore the UDG references of the part of the skool overwritten by the bottom row of the speech bubble (stored at <a class="link" href="32614.html#32624">32624</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29842"></a>29842</td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29844"></a>29844</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29845"></a>29845</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29847"></a>29847</td>
<td class="instruction">ADD A,128</td>
<td class="comment-11" rowspan="3">Point <span class="register">DE</span> at the skool graphic data attribute byte corresponding to the top-left corner of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29849"></a>29849</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29850"></a>29850</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29851"></a>29851</td>
<td class="instruction">LD C,8</td>
<td class="comment-11" rowspan="2">Restore the attribute bytes of the part of the skool overwritten by the top row of the speech bubble (stored at <a class="link" href="32614.html#32632">32632</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29853"></a>29853</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29855"></a>29855</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="4">Restore the attribute bytes of the part of the skool overwritten by the bottom row of the speech bubble (stored at <a class="link" href="32614.html#32640">32640</a> by the routine at <a class="link" href="29518.html">29518</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29856"></a>29856</td>
<td class="instruction">LD C,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29858"></a>29858</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29859"></a>29859</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="29861"></a>
<div class="comments">
<div class="paragraph">
Finally, clear the speech bubble lip coordinates (at <a class="link" href="32612.html">32612</a>) to indicate that no one is speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29861"></a>29861</td>
<td class="instruction">LD (32612),BC</td>
<td class="comment-11" rowspan="1">Set the speech bubble lip coordinates at to (0,0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29865"></a>29865</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the speaker's character number to <span class="register">H</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29866"></a>29866</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="29867"></a>29867</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="29735.html">29735</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#29746">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="29868.html">29868</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Skool Daze RAM disassembly 20150413</div>
<div class="copyright">&#169; 1984 Microsphere Computer Services Ltd (Skool Daze). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>